<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <h3>Wazuh, Ubuntu, Kali, Caldera — a super quick way of building a disposable cyber lab</h3> <p>Following on my series of Kasm-related posts, here I extend this further to build a cyber lab for logging machine activity using Wazuh SIEM, and for conducting attacks with Caldera. With Docker, Kasm, and a few tweaks, we can spin up a disposable lab in a matter of minutes.</p> <p>There are various tutorials online for trying to do similar setups to this — however, there are often snags and other issues that you find. Instead, this tutorial has been tested as of August 2025, and works with the Kasm Ubuntu VNC environments that I have been discussing in previous posts.</p> <h3>Step 1: Wazuh Manager in a Docker environment</h3> <p>First we set up Wazuh Manager in a Docker container. We <a href="https://documentation.wazuh.com/current/deployment-options/docker/wazuh-container.html" rel="external nofollow noopener" target="_blank">follow the guidance in their tutorial</a>.</p> <pre>git clone https://github.com/wazuh/wazuh-docker.git -b v4.12.0<br>cd ./wazuh-docker/single-node/<br>docker-compose -f generate-indexer-certs.yml run --rm generator<br></pre> <p><em>Note: For those using ARM (e.g., Mac M processor) you will need to edit the docker-compose.yml file directly and add </em><em>platform: linux/amd64 for each of the three services. An example for the manager is shown below:</em></p> <pre>services:<br>  wazuh.manager:<br>    image: wazuh/wazuh-manager:4.12.0<br>    hostname: wazuh.manager<br>    platform: linux/amd64</pre> <p>Once the docker compose file is ready, we can bring up the containers:</p> <pre>docker-compose up -d</pre> <p>You should now be able to log in to the web based Wazuh dashboard at <a href="https://localhost:443" rel="external nofollow noopener" target="_blank">https://localhost</a> with the credentials admin and SecretPassword.</p> <figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*BNbYhpgkzsBOLx-kQHcCxA.png"></figure> <h3>Step 2: Set up our Docker network</h3> <p>We want to create a new Docker network that we will attach all our containers to.</p> <pre># Create a new network 172.20 that will connect all machines<br>docker network create --subnet 172.20.0.0/16 mycyberlab<br><br># Connect the 3 Wazuh nodes<br>docker network connect mycyberlab single-node-wazuh.manager-1<br>docker network connect mycyberlab single-node-wazuh.indexer-1<br>docker network connect mycyberlab single-node-wazuh.dashboard-1<br><br># Find the IP address of our manager node on our new network<br>docker container inspect single-node-wazuh.manager-1 | grep IPAddress</pre> <p>I can see two IP addresses (since we have a network that is set up with our Wazuh nodes, and a new network that we will use for connecting any monitored hosts).</p> <ul> <li>“IPAddress”: “172.20.0.2”,</li> <li>“IPAddress”: “172.18.0.3”,</li> </ul> <p>We now know that the 172.20.0.2 address is how we can reach the manager system.</p> <h3>Step 3: Set up our Ubuntu endpoint</h3> <p>We fire up a new Ubuntu instance using the Kasm Docker images.</p> <pre>sudo docker run --rm -it --user root --platform linux/amd64 --name myubuntu --privileged --shm-size=512m -p 6901:6901 -e VNC_PW=password kasmweb/ubuntu-jammy-desktop-vpn:1.17.0<br>docker network connect mycyberlab myubuntu<br><br># First update and install simple ping<br>apt update<br>apt install iputils-ping</pre> <figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*05WI4tQZfqGsVSJw8td-LQ.png"></figure> <p>We can see that we now have two network connections, and we should be able to ping our Wazuh manager successfully.</p> <p>Note: we use the <a href="https://docs.docker.com/reference/cli/docker/container/run/#privileged" rel="external nofollow noopener" target="_blank">privileged flag</a> here so that we have greater control over the container. This results in a less secure environment, but it will be fine for our testing needs. However, do always be cautious when using this flag!</p> <p>Within this instance we set it up for logging:</p> <pre># Add the Wazuh repository and update<br>curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | gpg --no-default-keyring --keyring gnupg-ring:/usr/share/keyrings/wazuh.gpg --import &amp;&amp; chmod 644 /usr/share/keyrings/wazuh.gpg<br>echo "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main" | tee -a /etc/apt/sources.list.d/wazuh.list<br>apt update<br><br># We now pull the Wazuh agent, configure, install and start<br>WAZUH_MANAGER='172.20.0.2'<br>WAZUH_AGENT_NAME='myubuntu'<br>apt-get install wazuh-agent<br>/var/ossec/bin/wazuh-control start</pre> <p><em>Note: If you get Invalid server address found: MANAGER_IP, then in /var/ossec/etc/ossec.conf, replace MANAGER_IP with the expected IP address (i.e., 172.20.0.2).</em></p> <p>This deploys the agent and starts communicating with our server. All being good, we should see the agent appear in the Wazuh dashboard — we can restart the manager node if needed with:</p> <pre>docker container restart single-node-wazuh.manager-1</pre> <p><em>Note: We can see some logs however we need to explore how to get more useful and frequent logs from our system using tools like auditd, or how like sysmon would for Windows. Yes — there is also sysmonforlinux that we may add in here. Still playing around to decide our approach for the purpose of this exercise.</em></p> <p>With our SIEM running, and our Ubuntu endpoint logging to our SIEM, we can now move on to our adversary so that we can see something interest to log!</p> <h3>Step 4: Deploy a Kali instance and set up Caldera</h3> <p>As before, we can quickly spin up a Kali instance. We can also connect this to our network.</p> <pre>sudo docker run --rm -it --user root --platform linux/amd64 --name mykali --shm-size=512m -p 6905:6901 -e VNC_PW=password kasmweb/kali-rolling-desktop:1.17.0<br>docker network connect mycyberlab mykali</pre> <p>Within the Kali instance, we can then do the following to <a href="https://github.com/mitre/caldera" rel="external nofollow noopener" target="_blank">install Caldera</a>:</p> <pre># Apply the keyring fix that was recently published<br>sudo wget https://archive.kali.org/archive-keyring.gpg -O /usr/share/keyrings/kali-archive-keyring.gpg<br><br># First update and some useful libraries<br>apt update<br>apt install iputils-ping<br>apt install python3-lxml<br>apt install npm<br><br># Create a Python environment for running caldera<br>apt install python3.13-venv<br>python3 -m venv caldera-env<br>source ./caldera-env/bin/activate<br><br># Pull caldera and install<br>git clone https://github.com/mitre/caldera.git --recursive<br>cd caldera<br>pip3 install -r requirements.txt<br>python3 server.py --insecure --build<br></pre> <p><em>Note: If your requirements install throws an error, you may want to comment out lxml in requirements.txt and install manually as added above.</em></p> <p>Navigate to <a href="http://localhost:8888" rel="external nofollow noopener" target="_blank">http://localhost:8888</a> within the Kali instance, and use the username/password credentials red and admin to log in.</p> <figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*l4GPnUmL8smy3_nWKKds_Q.png"></figure> <h3>Recap</h3> <p>We now have have 3 components:</p> <ul> <li>Wazuh SIEM running in a Docker container</li> <li>Ubuntu desktop environment, running in a Docker container, that will serve as our target, with system logs being passed to our SIEM.</li> <li>Kali desktop environment, running in a Docker container, that will serve as our attack, set up with the MITRE Caldera adversary emulation platform.</li> </ul> <p>All this, from essentially 5 minutes of command line scripts! Wow.</p> <p>—</p> <p>Some other articles relating to Wazuh, Caldera, and AI integrations that may also be of interest!</p> <ul> <li><a href="https://wazuh.com/blog/adversary-emulation-with-caldera-and-wazuh/" rel="external nofollow noopener" target="_blank">Adversary emulation with CALDERA and Wazuh | Wazuh</a></li> <li><a href="https://socfortress.medium.com/introducing-wazuh-mcp-server-bridging-siem-and-ai-for-smarter-security-operations-ea9b5441dbba" rel="external nofollow noopener" target="_blank">🚀 Introducing Wazuh MCP Server: Bridging SIEM and AI for Smarter Security Operations</a></li> <li><a href="https://socfortress.medium.com/ai-agent-for-your-open-source-siem-stack-is-here-wazuh-velociraptor-and-copilot-just-got-2e0542aac697" rel="external nofollow noopener" target="_blank">🚀 AI Agent for Your Open-Source SIEM Stack Is Here — Wazuh, Velociraptor, and CoPilot Just Got…</a></li> </ul> <p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=1ad693665fa5" width="1" height="1" alt=""></p> </body></html>